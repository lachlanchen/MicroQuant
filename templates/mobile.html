<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Micro Quant — Mobile</title>
  <link rel="manifest" href="/static/manifest.webmanifest">
  <meta name="theme-color" content="#1976d2" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="apple-touch-icon" href="/static/logo.png" />
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  <style>
    :root {
      --accent: #1976d2;
      --accent2: #ff9800;
      --buy: #2ecc71;
      --sell: #e74c3c;
      --muted: #555;
      --bg: #ffffff;
      --panel: #f7f9fc;
      --text: #111;
      --line: #e0e6ef;
    }
    html, body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); }
    header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding: 10px 12px; background: linear-gradient(90deg, var(--accent), var(--accent2)); color:#fff; position:sticky; top:0; z-index:10; }
    header h2 { margin:0; font-size:16px; font-weight:700; }
    .tabs { display:none; gap:6px; padding:6px; background:var(--panel); border-bottom:1px solid var(--line); position:sticky; top:52px; z-index:9; }
    .tab { flex:1; text-align:center; padding:8px; border-radius:8px; border:1px solid var(--line); background:#fff; font-weight:600; }
    .tab.active { border-color: var(--accent); box-shadow: 0 1px 6px rgba(25,118,210,0.18); }
    .page { display:none; padding: 10px 12px; }
    .page.active { display:block; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    select, input, button { padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff; color:var(--text); }
    button.btn { font-weight:600; }
    button.buy { background: var(--buy); color:#fff; border:none; }
    button.sell { background: var(--sell); color:#fff; border:none; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--line); font-size:12px; background:#fff; }
    .panel { background:var(--panel); border:1px solid var(--line); border-radius:8px; padding:10px; }
    #mChart { width: 100%; height: 54vh; }
    .card { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; margin:8px 0; }

    /* Footer navigation (WeChat/MetaTrader style) */
    main { padding-bottom: calc(72px + env(safe-area-inset-bottom)); }
    .footer-nav { position: fixed; bottom: 0; left: 0; right: 0; background:#fff; border-top:1px solid var(--line); z-index: 20; padding: 6px 4px calc(6px + env(safe-area-inset-bottom)); }
    .footer-nav .row { justify-content: space-around; gap: 0; }
    .nav-item { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; min-width:64px; padding:6px 8px; border:none; background:transparent; color: var(--muted); font-weight:600; }
    .nav-item svg { width:22px; height:22px; }
    .nav-item.active { color: var(--accent); }
    .nav-item.active .dot { background: var(--accent); }
    .dot { width:6px; height:6px; border-radius:50%; background:transparent; }
  </style>
</head>
<body>
  <div id="app-cfg" data-symbols="{{ symbols_csv }}" data-default="{{ default_symbol_plain }}" data-ai="{{ 1 if news_ai_available else 0 }}" style="display:none"></div>
  <header>
    <h2>Micro Quant</h2>
    <div class="row" style="gap:8px; align-items:center;">
      <span id="mTicker" class="pill">—</span>
      <select id="mSymbol"></select>
      <select id="mTf">
        <option>H1</option><option>H4</option><option>D1</option>
      </select>
    </div>
  </header>
  <nav class="tabs">
    <button class="tab active" data-tab="chart">Chart</button>
    <button class="tab" data-tab="news">News</button>
    <button class="tab" data-tab="ai">AI Check</button>
    <button class="tab" data-tab="auto">Auto Trade</button>
  </nav>
  <main>
    <section id="page-chart" class="page active">
      <div class="row" style="margin-bottom:8px;">
        <label>BARS <input id="mBars" type="number" min="100" max="5000" value="{{ default_count }}" style="width:88px;"/></label>
        <button class="btn" id="mRefresh">Refresh</button>
        <button class="btn" id="mFetch">Fetch+Save</button>
      </div>
      <div id="mChart" class="panel"></div>
    </section>
    <section id="page-news" class="page">
      <div class="row" style="margin-bottom:6px;">
        <button class="btn" id="mNewsRefresh">Refresh News</button>
        <span id="mNewsStatus" class="pill">—</span>
      </div>
      <div id="mNewsList"></div>
    </section>
    <section id="page-ai" class="page">
      <div class="panel">
        <div class="row" style="margin-bottom:6px;">
          <label>Basic model <select id="mBasicModel"><option value="">(default)</option><option value="deepseek-chat">deepseek-chat</option><option value="deepseek-reasoner">deepseek-reasoner</option><option value="gpt-4o">gpt-4o</option></select></label>
          <button class="btn" id="mRunBasic">Basic Check</button>
          <span id="mBasicPill" class="pill">—</span>
        </div>
        <div class="row">
          <label>Tech+AI model <select id="mTechModel"><option value="">(default)</option><option value="deepseek-chat">deepseek-chat</option><option value="deepseek-reasoner">deepseek-reasoner</option><option value="gpt-4o">gpt-4o</option></select></label>
          <button class="btn" id="mRunTech">Tech+AI</button>
          <span id="mTechPill" class="pill">—</span>
        </div>
        <div class="row" style="margin-top:6px;">
          <label>Leverage <input id="mLev" type="number" min="1" max="1000" value="10" style="width:96px;"/></label>
          <label>Trade model <select id="mTradeModel"><option value="deepseek-chat">deepseek-chat</option><option value="deepseek-reasoner">deepseek-reasoner</option><option value="gpt-4o">gpt-4o</option></select></label>
          <button class="btn" id="mDraftPlan">Draft Plan</button>
        </div>
        <div class="row" style="margin-top:6px;">
          <label>Volume <input id="mVol" type="number" min="0.01" step="0.01" value="0.01" style="width:96px;"/></label>
          <label>Account <select id="mAcctSelect" style="min-width:160px;"></select></label>
          <button class="btn" id="mAcctLogin">Login</button>
        </div>
        <div class="row" style="margin-top:6px;">
          <button class="btn buy" id="mExecutePlan" style="flex:1;">Execute Plan</button>
        </div>
      </div>
      <div id="mAiOut" style="margin-top:8px;"></div>
      <div id="mPlanBox" style="margin-top:8px; font-size:13px;"></div>
    </section>
    <section id="page-auto" class="page">
      <div class="panel">
        <div class="row" style="margin-bottom:6px;">
          <label class="switch" style="gap:6px; align-items:center;">
            <input type="checkbox" id="mPeriodicToggle" />
            <span>Periodic Auto Trade</span>
          </label>
          <label>Period
            <select id="mPeriodicPeriod" style="min-width:120px;">
              <option value="15">15m</option>
              <option value="30">30m</option>
              <option value="60" selected>1h</option>
            </select>
          </label>
        </div>
        <div class="row" style="margin-bottom:6px;">
          <label>Symbols
            <select id="mPeriodicSymbols" multiple size="4" style="min-width:200px;"></select>
          </label>
          <label>Accounts
            <select id="mPeriodicAccounts" multiple size="3" style="min-width:200px;"></select>
          </label>
        </div>
        <div class="row" style="margin-bottom:6px;">
          <label>Volume <input id="mPeriodicVol" type="number" min="0.01" step="0.01" value="0.01" style="width:96px;"/></label>
          <button class="btn" id="mPeriodicTrigger">Danger Trigger</button>
          <button class="btn" id="mManageAccounts">Manage Accounts</button>
        </div>
        <div id="mAutoStatus" style="font-size:12px; color:var(--muted);"></div>
        <div id="mLotsSummary" style="font-size:12px; color:var(--muted); margin-top:4px;"></div>
      </div>
    </section>
  </main>

  <footer class="footer-nav">
    <div class="row" style="width:100%;">
      <button class="nav-item active" data-tab="chart" aria-label="Chart">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        <span>Chart</span>
        <span class="dot"></span>
      </button>
      <button class="nav-item" data-tab="news" aria-label="News">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        <span>News</span>
        <span class="dot"></span>
      </button>
      <button class="nav-item" data-tab="ai" aria-label="AI Check">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 3.6 15 1.65 1.65 0 0 0 2 14h-.09a2 2 0 1 1 0-4H2a1.65 1.65 0 0 0 1.6-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 8 3.6 1.65 1.65 0 0 0 9 2V1.91a2 2 0 1 1 4 0V2a1.65 1.65 0 0 0 1 1.6 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 20.4 8c.36.34.6.81.6 1.33 0 .52-.24.99-.6 1.33A1.65 1.65 0 0 0 22 12h.09a2 2 0 1 1 0 4H22a1.65 1.65 0 0 0-1.6 1z"/></svg>
        <span>AI</span>
        <span class="dot"></span>
      </button>
      <button class="nav-item" data-tab="auto" aria-label="Auto Trade">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        <span>Auto</span>
        <span class="dot"></span>
      </button>
    </div>
  </footer>

  <script>
    // SW registration
    if ('serviceWorker' in navigator) {
      try { navigator.serviceWorker.register('/static/sw.js'); } catch (e) {}
    }
    const cfg = document.getElementById('app-cfg');
    const APP_SYMBOLS = (cfg?.getAttribute('data-symbols')||'').split(',').map(s=>s.trim()).filter(Boolean);
    const APP_DEFAULT = cfg?.getAttribute('data-default')||'XAUUSD';
    const mSymbol = document.getElementById('mSymbol');
    const mTf = document.getElementById('mTf');
    const mBars = document.getElementById('mBars');
    const mTicker = document.getElementById('mTicker');
    const chartEl = document.getElementById('mChart');
    let lwChart = null, lwSeries = null;
    function curSymbol(){ return (mSymbol?.value||APP_DEFAULT).toUpperCase(); }
    function curTf(){ return (mTf?.value||'H1').toUpperCase(); }
    function curBars(){ return Math.max(100, Math.min(5000, Number(mBars?.value||500))); }

    // Fill selects
    (function initSelects(){
      if (mSymbol) mSymbol.innerHTML = APP_SYMBOLS.map(s=>`<option>${s}</option>`).join('');
      if (mSymbol && APP_SYMBOLS.includes(APP_DEFAULT)) mSymbol.value = APP_DEFAULT;
      if (mTf) mTf.value = '{{ default_tf }}';
    })();

    function switchTab(name){
      // Pages
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      const pg = document.getElementById('page-'+name);
      if (pg) pg.classList.add('active');
      // Bottom nav
      document.querySelectorAll('.nav-item').forEach(n=>n.classList.toggle('active', n.dataset.tab===name));
      // (Top tabs hidden by default, but sync anyway if later enabled)
      document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
    }
    document.querySelectorAll('.nav-item').forEach(btn=>{
      btn.addEventListener('click', ()=> switchTab(btn.dataset.tab));
    });
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=> switchTab(btn.dataset.tab));
    });

    // Chart
    function ensureChart(){
      if (!lwChart) {
        lwChart = LightweightCharts.createChart(chartEl, {
          layout: { background: { color: '#f7f9fc' }, textColor: '#111' },
          rightPriceScale: { borderColor: '#e0e6ef' },
          grid: { vertLines: { color:'#e0e6ef' }, horzLines: { color:'#e0e6ef' } },
          timeScale: { rightOffset: 10, fixRightEdge: false },
        });
        lwSeries = lwChart.addCandlestickSeries({ upColor:'#2ecc71', downColor:'#e74c3c', wickUpColor:'#2ecc71', wickDownColor:'#e74c3c', borderVisible:false });
      }
      return lwChart;
    }
    function applyChartSize(){
      const landscape = window.matchMedia && window.matchMedia('(orientation: landscape)').matches;
      const h = landscape ? Math.max(220, Math.round(window.innerHeight * 0.45)) : Math.max(300, Math.round(window.innerHeight * 0.65));
      chartEl.style.height = h + 'px';
      if (lwChart) {
        lwChart.applyOptions({ height: h, width: chartEl.clientWidth });
      }
    }
    async function loadChart(){
      ensureChart();
      applyChartSize();
      const sym = curSymbol(), tf = curTf();
      const r = await fetch(`/api/data?symbol=${encodeURIComponent(sym)}&tf=${encodeURIComponent(tf)}&limit=${curBars()}`, { cache:'no-store' });
      const js = await r.json().catch(()=>({}));
      const rows = Array.isArray(js.rows) ? js.rows : [];
      const data = rows.map(r=>({ time: Math.floor(new Date(r.ts).getTime()/1000), open:+r.open, high:+r.high, low:+r.low, close:+r.close }));
      lwSeries.setData(data);
      lwChart.timeScale().fitContent();
    }
    async function pollTick(){
      try {
        const sym = curSymbol();
        const r = await fetch(`/api/tick?symbol=${encodeURIComponent(sym)}`, { cache:'no-store' });
        const js = await r.json().catch(()=>({}));
        const bid = Number(js.bid), ask = Number(js.ask);
        if (Number.isFinite(bid) && Number.isFinite(ask)) {
          mTicker.textContent = `${sym} • Bid ${bid} • Ask ${ask}`;
        }
      } catch {}
      setTimeout(pollTick, 2000);
    }
    document.getElementById('mRefresh').addEventListener('click', loadChart);
    document.getElementById('mFetch').addEventListener('click', async ()=>{
      const sym = curSymbol(), tf = curTf();
      await fetch(`/api/fetch?symbol=${encodeURIComponent(sym)}&tf=${encodeURIComponent(tf)}&count=${curBars()}`, { cache:'no-store' });
      loadChart();
    });
    mSymbol.addEventListener('change', loadChart);
    mTf.addEventListener('change', loadChart);

    // News
    function fmtPub(ts){
      try {
        if (!ts) return '';
        let v = String(ts);
        if (v.endsWith('Z')) v = v.replace(/Z$/, '+00:00');
        if (v.includes(' ') && !v.includes('T')) v = v.replace(' ', 'T');
        const d = new Date(v);
        if (!isNaN(d.getTime())) return d.toLocaleString();
      } catch {}
      return String(ts);
    }
    async function loadNews({ refresh = false } = {}){
      const sym = curSymbol();
      const box = document.getElementById('mNewsList');
      const pill = document.getElementById('mNewsStatus');
      try {
        pill.textContent = 'Loading…';
        const url = `/api/news?symbol=${encodeURIComponent(sym)}` + (refresh ? `&refresh=1` : '');
        const r = await fetch(url, { cache:'no-store' });
        const js = await r.json().catch(()=>({}));
        const arr = js && Array.isArray(js.news) ? js.news : [];
        if (!arr.length) {
          box.innerHTML = '<em style="color:var(--muted)">No recent news</em>';
        } else {
          box.innerHTML = arr.map(a=>{
            const title = (a.title||a.headline||'').toString();
            const link = a.url || a.link || '';
            const source = a.source || a.provider || '';
            const pub = fmtPub(a.published_at || a.publishedAt || a.published || a.date);
            const summary = (a.summary || a.snippet || '').toString();
            const head = link ? `<a href="${link}" target="_blank" rel="noopener noreferrer" style="text-decoration:none; color:inherit;">${title}</a>` : title;
            return `<div class=\"card\">
              <div style=\"font-weight:600;\">${head}</div>
              <div style=\"font-size:12px; color:var(--muted);\">${source ? source + ' • ' : ''}${pub}</div>
              <div style=\"margin-top:6px;\">${summary ? summary.slice(0, 360) : ''}</div>
            </div>`;
          }).join('');
        }
        pill.textContent = `Loaded ${arr.length}`;
      } catch (e) { pill.textContent = 'Error'; }
    }
    document.getElementById('mNewsRefresh').addEventListener('click', ()=> loadNews({ refresh: true }));

    // AI: Basic & Tech
    const PREF = '/api/preferences';
    async function loadAiPrefs(){
      try {
        const r = await fetch(`${PREF}?keys=basic_ai_model,tech_ai_model,trade_ai_model`, { cache:'no-store' });
        const js = await r.json().catch(()=>({}));
        const p = (js && js.prefs) || {};
        const b = document.getElementById('mBasicModel'); if (b && p.basic_ai_model) b.value = p.basic_ai_model;
        const t = document.getElementById('mTechModel'); if (t && p.tech_ai_model) t.value = p.tech_ai_model;
        const tm = document.getElementById('mTradeModel'); if (tm && p.trade_ai_model) tm.value = p.trade_ai_model;
      } catch {}
    }
    async function runBasic(){
      const sym = curSymbol();
      const tf = curTf();
      const model = document.getElementById('mBasicModel').value;
      const out = document.getElementById('mAiOut');
      out.textContent = 'Running Basic…';
      const payload = { symbol: sym, timeframe: tf, n_bars: 50 };
      if (model) payload.model = model;
      try {
        const r = await fetch('/api/health/run', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), cache:'no-store' });
        const js = await r.json().catch(()=>({}));
        out.textContent = JSON.stringify(js, null, 2);
        document.getElementById('mBasicPill').textContent = js && js.signal ? js.signal : '—';
      } catch (e) { out.textContent = String(e); }
    }
    async function runTech(){
      const sym = curSymbol();
      const tf = curTf();
      const model = document.getElementById('mTechModel').value;
      const out = document.getElementById('mAiOut');
      out.textContent = 'Running Tech+AI…';
      // Build a minimal snapshot: last N closes + tick line
      const data = await fetch(`/api/data?symbol=${encodeURIComponent(sym)}&tf=${encodeURIComponent(tf)}&limit=${200}`, { cache:'no-store' }).then(r=>r.json()).catch(()=>({}));
      const closes = (data.rows||[]).map(r=>+r.close);
      const tick = await fetch(`/api/tick?symbol=${encodeURIComponent(sym)}`, { cache:'no-store' }).then(r=>r.json()).catch(()=>({}));
      const tline = tick && (Number.isFinite(+tick.bid) && Number.isFinite(+tick.ask)) ? `Latest Tick — Bid ${tick.bid} • Ask ${tick.ask}` : '';
      const snapshot = `Close Price\n` + closes.slice(-50).map(v=>String(v)).join(', ') + (tline?`\n${tline}`:'');
      const body = { symbol:sym, timeframe:tf, tech_snapshot:snapshot, strategy:'tech_snapshot_10q_position.json' };
      if (model) body.model = model;
      try {
        const r = await fetch('/api/health/run', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body), cache:'no-store' });
        const js = await r.json().catch(()=>({}));
        out.textContent = JSON.stringify(js, null, 2);
        document.getElementById('mTechPill').textContent = js && js.signal ? js.signal : '—';
      } catch (e) { out.textContent = String(e); }
    }
    document.getElementById('mRunBasic').addEventListener('click', runBasic);
    document.getElementById('mRunTech').addEventListener('click', runTech);

    // Auto Trade: draft plan only (non-blocking)
    async function draftPlan(){
      const sym = curSymbol(); const tf = curTf();
      const model = document.getElementById('mTradeModel').value;
      const out = document.getElementById('mPlanBox'); out.textContent='Drafting…';
      const data = await fetch(`/api/data?symbol=${encodeURIComponent(sym)}&tf=${encodeURIComponent(tf)}&limit=300`, { cache:'no-store' }).then(r=>r.json()).catch(()=>({}));
      const closes = (data.rows||[]).map(r=>+r.close);
      const tick = await fetch(`/api/tick?symbol=${encodeURIComponent(sym)}`, { cache:'no-store' }).then(r=>r.json()).catch(()=>({}));
      const tline = tick && (Number.isFinite(+tick.bid) && Number.isFinite(+tick.ask)) ? `Latest Tick — Bid ${tick.bid} • Ask ${tick.ask}` : '';
      const snapshot = `Close Price\n` + closes.slice(-50).map(v=>String(v)).join(', ') + (tline?`\n${tline}`:'');
      const lev = Number(document.getElementById('mLev').value||'10');
      const body = { symbol:sym, timeframe:tf, action:'BUY', tech_snapshot:snapshot, model, leverage: lev };
      try {
        const r = await fetch('/api/ai/trade_plan', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body), cache:'no-store' });
        const js = await r.json().catch(()=>({}));
        out.textContent = JSON.stringify(js, null, 2);
        try { const p = (js && js.plan) || {}; mLastPlan = { position: (p.position||'').toUpperCase(), stop_loss: p.stop_loss, take_profit: p.take_profit }; } catch {}
      } catch (e) { out.textContent = String(e); }
    }
    document.getElementById('mDraftPlan').addEventListener('click', draftPlan);

    // Accounts
    async function loadAccounts(){
      try {
        const r = await fetch('/api/accounts', { cache:'no-store' });
        const js = await r.json().catch(()=>({}));
        const arr = Array.isArray(js.accounts) ? js.accounts : [];
        const last = js.last || '';
        const acctSel = document.getElementById('mAcctSelect');
        const perSel = document.getElementById('mPeriodicAccounts');
        if (acctSel) {
          acctSel.innerHTML = arr.map(a=>`<option value="${String(a.login)}">${a.login}${a.server?(' ('+a.server+')'):''}</option>`).join('');
          if (last) acctSel.value = String(last);
        }
        if (perSel) {
          perSel.innerHTML = arr.map(a=>`<option value="${String(a.login)}">${a.login}${a.server?(' ('+a.server+')'):''}</option>`).join('');
          // Preselect last if present
          if (last) { Array.from(perSel.options).forEach(o=>{ o.selected = (o.value===String(last)); }); }
        }
      } catch {}
    }
    async function loginSelectedAccount(){
      const sel = document.getElementById('mAcctSelect');
      const login = sel && sel.value ? sel.value : '';
      if (!login) return alert('Select an account first');
      const r = await fetch('/api/account/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ login }) });
      const js = await r.json().catch(()=>({}));
      alert(js && js.ok ? `Logged in: ${login}` : `Login failed: ${(js && js.error) || 'unknown'}`);
    }
    document.getElementById('mAcctLogin').addEventListener('click', loginSelectedAccount);

    // Execute plan
    let mLastPlan = null;
    document.getElementById('mExecutePlan').addEventListener('click', async ()=>{
      try {
        if (!mLastPlan || !mLastPlan.position) { alert('Draft a plan first'); return; }
        const sym = curSymbol(); const tf = curTf();
        const vol = Number(document.getElementById('mVol').value||'0.01');
        const side = String(mLastPlan.position||'').toLowerCase();
        const sl = Number(mLastPlan.stop_loss||0)||undefined;
        const tp = Number(mLastPlan.take_profit||0)||undefined;
        // Ensure account session
        await loginSelectedAccount();
        const params = new URLSearchParams({ symbol: sym, side, volume: String(vol) });
        if (Number.isFinite(sl)) params.set('sl', String(sl));
        if (Number.isFinite(tp)) params.set('tp', String(tp));
        params.set('tf', tf);
        params.set('strategy', 'ai_trade_plan');
        const r = await fetch(`/api/trade?${params.toString()}`, { cache:'no-store' });
        const js = await r.json().catch(()=>({}));
        alert(js && js.ok ? 'Order placed' : `Order failed: ${(js && js.error) || 'unknown'}`);
      } catch (e) { alert('Error: '+ (e && e.message || e)); }
    });

    // Periodic
    function fillPeriodicSymbols(){
      const sel = document.getElementById('mPeriodicSymbols');
      if (sel) sel.innerHTML = APP_SYMBOLS.map(s=>`<option>${s}</option>`).join('');
      // default to current symbol
      try { Array.from(sel.options).forEach(o=>{ o.selected = (o.value===curSymbol()); }); } catch {}
    }
    function selectedValues(sel){ return Array.from(sel && sel.selectedOptions ? sel.selectedOptions : []).map(o=>o.value); }
    async function updateMobileLotsSummary(){
      const lotsBox = document.getElementById('mLotsSummary');
      try {
        const r = await fetch('/api/positions/all', { cache:'no-store' });
        const js = await r.json().catch(()=>({}));
        const arr = Array.isArray(js && js.positions) ? js.positions : [];
        const sum = (pred) => arr.filter(pred).reduce((a,x)=>a+(Number(x && x.volume)||0),0);
        const cur = sum(x => String(x.symbol||'').toUpperCase() === String(curSymbol()||'').toUpperCase());
        const xau = sum(x => String(x.symbol||'').toUpperCase().startsWith('XAU'));
        const xag = sum(x => String(x.symbol||'').toUpperCase().startsWith('XAG'));
        const fxOther = sum(x => { const s=String(x.symbol||'').toUpperCase(); return /^[A-Z]{6,7}$/.test(s) && !s.startsWith('XAU') && !s.startsWith('XAG'); });
        const stocks = sum(x => { const s=String(x.symbol||'').toUpperCase(); return !/^[A-Z]{6,7}$/.test(s); });
        if (lotsBox) lotsBox.textContent = `Open lots — cur ${curSymbol()}: ${cur.toFixed(2)} • XAU: ${xau.toFixed(2)} • XAG: ${xag.toFixed(2)} • FX: ${fxOther.toFixed(2)} • Stocks: ${stocks.toFixed(2)}`;
      } catch {}
    }

    async function runPeriodicBatch(){
      const info = document.getElementById('mAutoStatus');
      await updateMobileLotsSummary();
      const symSel = document.getElementById('mPeriodicSymbols');
      const acctSel = document.getElementById('mPeriodicAccounts');
      const symbols = selectedValues(symSel);
      const accounts = selectedValues(acctSel);
      const vol = Number(document.getElementById('mPeriodicVol').value||'0.01');
      const tf = curTf();
      for (const sym of symbols){
        try {
          info.textContent = `[${sym}] Tech+AI…`;
          // Preflight: Safe max account cap
          try {
            const keys = encodeURIComponent(`safe_max_lots:global,safe_max_lots:${sym}:${tf}`);
            const pref = await fetch(`/api/preferences?keys=${keys}`, { cache:'no-store' });
            const pj = await pref.json().catch(()=>({}));
            const map = (pj && pj.prefs) || pj || {};
            const vg = Number(map['safe_max_lots:global']);
            const vs = Number(map[`safe_max_lots:${sym}:${tf}`]);
            const useGlobal = Number.isFinite(vg) && vg>0;
            const safeMax = useGlobal ? vg : (Number.isFinite(vs) && vs>0 ? vs : NaN);
              if (Number.isFinite(safeMax) && safeMax > 0) {
                let arr = [];
                if (useGlobal) {
                  const ra = await fetch('/api/positions/all', { cache:'no-store' });
                  const ja = await ra.json().catch(()=>({}));
                  arr = Array.isArray(ja && ja.positions) ? ja.positions : [];
                } else {
                  const pr = await fetch(`/api/positions?symbol=${encodeURIComponent(sym)}`, { cache:'no-store' });
                  const pjs = await pr.json().catch(()=>({}));
                  arr = Array.isArray(pjs && pjs.positions) ? pjs.positions : (Array.isArray(pjs && pjs.rows) ? pjs.rows : []);
                }
                const openLots = arr.reduce((acc, x)=>acc+(Number(x && x.volume)||0), 0);
                if (openLots >= safeMax) {
                  info.textContent = `[${sym}] Skip: safe max lots reached — no trade.`;
                  try { await fetch('/api/auto_trade/log', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ symbol:sym, timeframe:tf, action:null, skipped:true, skip_reason:'safe_max', periodic:true, steps: [], order_result:{ ok:false, skipped:true, error:'safe_max_exceeded', open_lots:openLots, safe_max:safeMax, global:useGlobal } }) }); } catch {}
                  continue;
                }
              }
            } catch {}
          // Build snapshot
          const data = await fetch(`/api/data?symbol=${encodeURIComponent(sym)}&tf=${encodeURIComponent(tf)}&limit=300`, { cache:'no-store' }).then(r=>r.json()).catch(()=>({}));
          const closes = (data.rows||[]).map(r=>+r.close);
          const tick = await fetch(`/api/tick?symbol=${encodeURIComponent(sym)}`, { cache:'no-store' }).then(r=>r.json()).catch(()=>({}));
          const tline = tick && (Number.isFinite(+tick.bid) && Number.isFinite(+tick.ask)) ? `Latest Tick — Bid ${tick.bid} • Ask ${tick.ask}` : '';
          const snapshot = `Close Price\n` + closes.slice(-50).map(v=>String(v)).join(', ') + (tline?`\n${tline}`:'');
          // Tech+AI run (signal)
          const techRes = await fetch('/api/health/run', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ symbol:sym, timeframe:tf, tech_snapshot:snapshot, strategy:'tech_snapshot_10q_position.json' }), cache:'no-store' }).then(r=>r.json()).catch(()=>({}));
          const techSignal = (techRes && techRes.signal) ? String(techRes.signal).toUpperCase() : '';
          // Basic run
          const basicRes = await fetch('/api/health/run', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ symbol:sym, timeframe:tf, n_bars:50 }), cache:'no-store' }).then(r=>r.json()).catch(()=>({}));
          const basicSignal = (basicRes && basicRes.signal) ? String(basicRes.signal).toUpperCase() : '';
          const aligned = (techSignal==='BUY' && basicSignal==='BULLISH') || (techSignal==='SELL' && basicSignal==='BEARISH');
          if (!aligned){ info.textContent = `[${sym}] Skip: not aligned (Tech=${techSignal} Basic=${basicSignal})`; continue; }
          // Draft plan
          const planRes = await fetch('/api/ai/trade_plan', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ symbol:sym, timeframe:tf, action: techSignal, tech_snapshot:snapshot }), cache:'no-store' }).then(r=>r.json()).catch(()=>({}));
          const p = (planRes && planRes.plan) || {};
          const side = String(p.position||techSignal||'').toLowerCase();
          const sl = p.stop_loss; const tp = p.take_profit;
          for (const acct of accounts){
            // Safe max lots guard (global then per-symbol×TF)
            try {
              const keys = encodeURIComponent(`safe_max_lots:global,safe_max_lots:${sym}:${tf}`);
              const pref = await fetch(`/api/preferences?keys=${keys}`, { cache:'no-store' });
              const pj = await pref.json().catch(()=>({}));
              const map = (pj && pj.prefs) || pj || {};
              const vg = Number(map['safe_max_lots:global']);
              const vs = Number(map[`safe_max_lots:${sym}:${tf}`]);
              const useGlobal = Number.isFinite(vg) && vg>0;
              const safeMax = useGlobal ? vg : (Number.isFinite(vs) && vs>0 ? vs : NaN);
              if (Number.isFinite(safeMax) && safeMax > 0) {
                let arr = [];
                if (useGlobal) {
                  const ra = await fetch('/api/positions/all', { cache:'no-store' });
                  const ja = await ra.json().catch(()=>({}));
                  arr = Array.isArray(ja && ja.positions) ? ja.positions : [];
                } else {
                  const pr = await fetch(`/api/positions?symbol=${encodeURIComponent(sym)}`, { cache:'no-store' });
                  const pjs = await pr.json().catch(()=>({}));
                  arr = Array.isArray(pjs && pjs.positions) ? pjs.positions : (Array.isArray(pjs && pjs.rows) ? pjs.rows : []);
                }
                const openLots = arr.reduce((acc, x)=>acc+(Number(x && x.volume)||0), 0);
                if (openLots >= safeMax) {
                  info.textContent = `[${sym}] Skip: safe max lots reached — no trade.`;
                  try { await fetch('/api/auto_trade/log', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ symbol:sym, timeframe:tf, action: side.toUpperCase(), skipped:true, skip_reason:'safe_max', order_result:{ ok:false, skipped:true, error:'safe_max_exceeded', open_lots:openLots, safe_max:safeMax } }) }); } catch {}
                  continue;
                }
              }
            } catch {}
            await fetch('/api/account/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ login: acct }) }).then(r=>r.json()).catch(()=>({}));
            const qp = new URLSearchParams({ symbol: sym, side, volume: String(vol) });
            if (Number.isFinite(+sl)) qp.set('sl', String(sl));
            if (Number.isFinite(+tp)) qp.set('tp', String(tp));
            qp.set('tf', tf);
            await fetch(`/api/trade?${qp.toString()}`, { cache:'no-store' });
            info.textContent = `[${sym}] Order attempted for ${acct}`;
          }
        } catch (e) { info.textContent = `[${sym}] Error ${e && e.message || e}`; }
      }
    }
    let periodicTimer = null; let periodicAlignTimer = null;
    function ensurePeriodic(){
      const on = document.getElementById('mPeriodicToggle').checked;
      const min = Number(document.getElementById('mPeriodicPeriod').value||'60');
      if (!on){ if (periodicTimer) clearInterval(periodicTimer); if (periodicAlignTimer) clearTimeout(periodicAlignTimer); periodicTimer=null; periodicAlignTimer=null; return; }
      // Align to next period boundary (clock minutes)
      const now = new Date();
      const ms = now.getMinutes()*60*1000 + now.getSeconds()*1000 + now.getMilliseconds();
      const periodMs = min*60*1000;
      const delay = (periodMs - (ms % periodMs)) % periodMs;
      if (periodicAlignTimer) clearTimeout(periodicAlignTimer);
      periodicAlignTimer = setTimeout(()=>{
        runPeriodicBatch();
        if (periodicTimer) clearInterval(periodicTimer);
        periodicTimer = setInterval(runPeriodicBatch, periodMs);
      }, delay || 1000);
    }
    document.getElementById('mPeriodicToggle').addEventListener('change', ensurePeriodic);
    document.getElementById('mPeriodicPeriod').addEventListener('change', ensurePeriodic);
    document.getElementById('mPeriodicTrigger').addEventListener('click', runPeriodicBatch);
    // Initial lots summary
    (async ()=>{ try { await updateMobileLotsSummary(); } catch {} })();
    document.getElementById('mManageAccounts').addEventListener('click', async ()=>{
      const login = prompt('Login (account id):'); if (!login) return;
      const password = prompt('Password:'); if (!password) return;
      const server = prompt('Server (optional):')||'';
      const r = await fetch('/api/accounts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ login, password, server }) });
      const js = await r.json().catch(()=>({}));
      alert(js && js.ok ? 'Saved' : `Save failed: ${(js && js.error) || 'unknown'}`);
      loadAccounts();
    });

    // Init
    function initPeriodicSymbols(){ const sel = document.getElementById('mPeriodicSymbols'); if (sel && !sel.options.length) fillPeriodicSymbols(); }
    loadAiPrefs();
    loadAccounts();
    initPeriodicSymbols();
    loadChart();
    loadNews();
    pollTick();
    applyChartSize();
    window.addEventListener('resize', applyChartSize);
    window.addEventListener('orientationchange', applyChartSize);
  </script>
</body>
</html>

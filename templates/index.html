<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MT5 Gold Data — Starter</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  <!-- Time scale adapter for Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    #status { margin-top: 8px; color: #555; }
    #chart-wrap { max-width: 1000px; }
  </style>
  <link rel="icon" href="data:," />
  </head>
  <body>
    <h2>MT5 Gold Data — Starter</h2>
    <div class="row">
      <label>Symbol
        <input id="symbol" value="XAUUSD" />
      </label>
      <label>Timeframe
        <select id="tf">
          <option value="M1">M1</option>
          <option value="M5">M5</option>
          <option value="M15">M15</option>
          <option value="M30">M30</option>
          <option value="H1" selected>H1</option>
          <option value="H4">H4</option>
          <option value="D1">D1</option>
        </select>
      </label>
      <label>Bars
        <input id="count" type="number" min="10" max="5000" value="500" />
      </label>
      <button id="btnFetch">Fetch + Save</button>
      <button id="btnRefresh">Refresh Chart</button>
    </div>
    <div id="status"></div>

    <div id="chart-wrap">
      <canvas id="chart" height="400"></canvas>
    </div>

    <script>
      const el = (id) => document.getElementById(id);
      const status = (msg) => el('status').textContent = msg || '';

      const ctx = document.getElementById('chart');
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Close',
            data: [],
            borderColor: '#d4a017',
            tension: 0.1,
            fill: false,
          }]
        },
        options: {
          scales: {
            x: { type: 'time', time: { unit: 'hour' } },
            y: { beginAtZero: false }
          }
        }
      });

      async function refreshChart() {
        const symbol = el('symbol').value.trim();
        const tf = el('tf').value;
        status('Loading data...');
        const r = await fetch(`/api/data?symbol=${encodeURIComponent(symbol)}&tf=${encodeURIComponent(tf)}&limit=500`);
        const js = await r.json();
        const rows = js.rows || [];
        chart.data.labels = rows.map(r => r.ts);
        chart.data.datasets[0].data = rows.map(r => r.close);
        chart.update();
        status(`Loaded ${rows.length} bars for ${symbol} ${tf}`);
      }

      async function fetchAndSave() {
        const symbol = el('symbol').value.trim();
        const tf = el('tf').value;
        const count = el('count').value;
        status('Fetching from MT5...');
        const r = await fetch(`/api/fetch?symbol=${encodeURIComponent(symbol)}&tf=${encodeURIComponent(tf)}&count=${encodeURIComponent(count)}`);
        const js = await r.json();
        if (js.ok) {
          status(`Inserted/updated ${js.inserted} bars for ${symbol} ${tf}`);
          await refreshChart();
        } else {
          status(`Error: ${js.error}`);
        }
      }

      el('btnFetch').addEventListener('click', fetchAndSave);
      el('btnRefresh').addEventListener('click', refreshChart);
      // Initial load
      refreshChart();
    </script>
  </body>
  </html>
